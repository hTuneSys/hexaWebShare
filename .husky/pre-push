#!/bin/sh

# SPDX-FileCopyrightText: 2025 hexaTune LLC
# SPDX-License-Identifier: MIT

# Pre-push hook for CI quality checks
# This hook ensures all CI checks pass before pushing to remote

echo ""
echo "ğŸ” Running CI checks before push..."
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Check if we're in the correct directory
if [ ! -d "hexawebshare" ]; then
    echo "âŒ ERROR: hexawebshare directory not found!"
    echo "Please run this hook from the repository root."
    echo ""
    exit 1
fi

# Navigate to hexawebshare directory
cd hexawebshare || exit 1

# Check if pnpm is installed
if ! command -v pnpm >/dev/null 2>&1; then
    echo "âŒ ERROR: pnpm not found!"
    echo ""
    echo "ğŸ“¦ pnpm is required for this project."
    echo ""
    echo "ğŸ”§ Installation Instructions:"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "Install pnpm globally:"
    echo "  $ npm install -g pnpm"
    echo ""
    echo "Or with Homebrew (macOS):"
    echo "  $ brew install pnpm"
    echo ""
    echo "For more options, visit:"
    echo "  https://pnpm.io/installation"
    echo ""
    exit 1
fi

# Check if node_modules exists
if [ ! -d "node_modules" ]; then
    echo "âš ï¸  WARNING: node_modules not found!"
    echo "Installing dependencies first..."
    echo ""
    pnpm install
    if [ $? -ne 0 ]; then
        echo ""
        echo "âŒ Dependency installation failed!"
        exit 1
    fi
    echo ""
fi

# 1. Type check
echo "ğŸ“˜ [1/4] Running TypeScript type check..."
pnpm check
if [ $? -ne 0 ]; then
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "âŒ Type check FAILED!"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "ğŸ’¡ Fix TypeScript errors before pushing"
    echo ""
    echo "To see detailed errors, run:"
    echo "  $ cd hexawebshare && pnpm check"
    echo ""
    exit 1
fi
echo "âœ… Type check passed"
echo ""

# 2. Format check
echo "ğŸ“ [2/4] Checking code formatting..."
pnpm lint
if [ $? -ne 0 ]; then
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "âŒ Format check FAILED!"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "ğŸ’¡ Run 'pnpm format' to auto-fix formatting issues"
    echo ""
    echo "To format your code, run:"
    echo "  $ cd hexawebshare && pnpm format"
    echo ""
    exit 1
fi
echo "âœ… Format check passed"
echo ""

# 3. Build check
echo "ğŸ—ï¸  [3/4] Building library package..."
pnpm build
if [ $? -ne 0 ]; then
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "âŒ Build FAILED!"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "ğŸ’¡ Fix build errors before pushing"
    echo ""
    echo "To see detailed errors, run:"
    echo "  $ cd hexawebshare && pnpm build"
    echo ""
    exit 1
fi
echo "âœ… Build passed"
echo ""

# 4. Storybook build check
echo "ğŸ“š [4/4] Building Storybook..."
pnpm build-storybook
if [ $? -ne 0 ]; then
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "âŒ Storybook build FAILED!"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "ğŸ’¡ Fix Storybook configuration/stories before pushing"
    echo ""
    echo "To see detailed errors, run:"
    echo "  $ cd hexawebshare && pnpm build-storybook"
    echo ""
    exit 1
fi
echo "âœ… Storybook build passed"
echo ""

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ¨ All CI checks passed! Proceeding with push..."
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
