#!/bin/sh

# SPDX-FileCopyrightText: 2025 hexaTune LLC
# SPDX-License-Identifier: MIT

# Pre-commit hook for REUSE compliance check
# This hook ensures all files have proper SPDX license headers

# Add common paths where reuse might be installed
export PATH="$HOME/.local/bin:$PATH:/usr/local/bin"

echo "ğŸ” Running REUSE compliance check..."

# Check if reuse command exists
if ! command -v reuse > /dev/null 2>&1; then
    echo ""
    echo "âŒ ERROR: 'reuse' command not found!"
    echo ""
    echo "ğŸ“¦ REUSE is required for license compliance checking."
    echo ""
    echo "ğŸ”§ Installation Instructions:"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "Option 1: Install with pipx (recommended)"
    echo "  $ pipx install reuse"
    echo ""
    echo "Option 2: Install with pip (system-wide)"
    echo "  $ pip install --user reuse"
    echo ""
    echo "Option 3: Install with pip (virtual environment)"
    echo "  $ python -m venv venv"
    echo "  $ source venv/bin/activate"
    echo "  $ pip install reuse"
    echo ""
    echo "Option 4: Install pipx first, then install reuse"
    echo "  $ python3 -m pip install --user pipx"
    echo "  $ python3 -m pipx ensurepath"
    echo "  $ pipx install reuse"
    echo ""
    echo "For more installation options, visit:"
    echo "  https://reuse.software/tutorial/#step-0"
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    exit 1
fi

# Get REUSE version
REUSE_VERSION=$(reuse --version 2>&1 | grep -oP '\d+\.\d+\.\d+' | head -1)

if [ -z "$REUSE_VERSION" ]; then
    echo ""
    echo "âš ï¸  WARNING: Could not detect REUSE version"
    echo "Proceeding with REUSE lint check anyway..."
    echo ""
else
    # Extract major version
    MAJOR_VERSION=$(echo "$REUSE_VERSION" | cut -d. -f1)
    
    echo "ğŸ“Œ Detected REUSE version: $REUSE_VERSION"
    
    # Check if version is less than 3
    if [ "$MAJOR_VERSION" -lt 3 ]; then
        echo ""
        echo "âš ï¸  WARNING: REUSE version $REUSE_VERSION is older than 3.x"
        echo ""
        echo "ğŸ”„ Upgrade Instructions:"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "If installed with pipx:"
        echo "  $ pipx upgrade reuse"
        echo ""
        echo "If installed with pip:"
        echo "  $ pip install --upgrade reuse"
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "â­ï¸  Continuing with current version..."
        echo ""
    fi
fi

# Run REUSE lint
echo "ğŸ” Running: reuse lint"
echo ""

if ! reuse lint; then
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "âŒ REUSE compliance check FAILED!"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "Please fix the REUSE compliance issues above before committing."
    echo ""
    echo "ğŸ“š Common fixes:"
    echo "  â€¢ Add SPDX headers to files missing license information"
    echo "  â€¢ Use REUSE.toml to annotate files that cannot have headers"
    echo "  â€¢ Ensure all licenses are in LICENSES/ directory"
    echo ""
    echo "For more information:"
    echo "  https://reuse.software/tutorial/"
    echo ""
    exit 1
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… REUSE compliance check PASSED!"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
exit 0
